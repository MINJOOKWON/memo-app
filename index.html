<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>メモ帳</title>
  <style>
    body { font-family: Arial, sans-serif; }
    h1 { text-align:center; }
    .tabs { display:flex; gap:8px; justify-content:center; margin:12px 0; }
    .tab { padding:10px 16px; border:1px solid #ccc; background:#f1f1f1; cursor:pointer; }
    .tab.active { background:#ddd; }
    .tab-content { display:none; max-width:1000px; margin:0 auto; }
    .tab-content.active { display:block; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }

    /* ▶ 입력칸 짧게 (겹침 방지) */
    .field { display:flex; flex-direction:column; gap:6px; }
    .short-input { width: 180px; padding:8px; }   /* 여기서 길이 조절 */
    @media (max-width: 480px) {
      .short-input { width: 140px; }
    }

    .category { margin: 16px 0; }
    .category label { display:block; font-weight:bold; margin-bottom:6px; }
    .category textarea { width:100%; min-height:70px; padding:8px; }
    .button { padding:8px 14px; border:none; cursor:pointer; color:#fff; background:#4CAF50; }
    .button:hover { filter:brightness(0.95); }
    .saveButton { background:#007bff; }
    .deleteButton { background:#dc3545; }
    .editButton { background:#f39c12; }
    .closeButton { background:#888; }

    #savedMemoList { list-style:none; padding-left:0; max-width:1000px; margin:0 auto; }
    #savedMemoList li { font-size:12px; border-bottom:1px solid #eee; padding:10px 0; }
    .memo-head { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .memo-title { font-weight:bold; font-size:14px; }
    .memo-actions .button { margin-left:6px; }

    .details { display:none; margin-top:10px; padding:12px; background:#fafafa; border:1px solid #e8e8e8; border-radius:6px; }
    .details.visible { display:block; }
    .image-preview img { max-width:100%; max-height:200px; cursor:pointer; display:block; margin:6px 0; }

    #categories { margin-top:16px; }
    #categories .image-preview img { max-width:100%; max-height:200px; cursor:pointer; }
    .hint { color:#777; font-size:12px; }
  </style>
</head>
<body>

<h1>メモ帳</h1>

<div class="tabs">
  <div class="tab active" id="tabCreate" onclick="switchTab('create')">メモ作成</div>
  <div class="tab" id="tabList" onclick="switchTab('list')">メモリスト</div>
</div>

<!-- メモ作成 -->
<div id="createTabContent" class="tab-content active">
  <div style="max-width:1000px; margin:0 auto;">
    <div class="row">
      <div class="field">
        <label for="title">話数</label>
        <input type="text" id="title" class="short-input" placeholder="話数を入力してください"/>
      </div>
      <div class="field">
        <label for="cutNumber">cut</label>
        <input type="text" id="cutNumber" class="short-input" placeholder="cutを入力してください"/>
      </div>
      <div>
        <button class="button" onclick="createCategories()">하위 카테고리 생성</button>
      </div>
    </div>
    <div id="categories" style="display:none;"></div>
  </div>
</div>

<!-- メモリスト -->
<div id="listTabContent" class="tab-content">
  <div style="max-width:1000px; margin:0 auto;">
    <div class="row" style="margin-bottom:10px;">
      <button class="button" onclick="sortMemosByTitle()">タイトル順で並べ替え</button>
      <button class="button" onclick="sortMemosByDate()">最新順で並べ替え</button>
      <span class="hint">보기를 누르면 해당 항목 바로 아래에 내용이 펼쳐집니다.</span>
    </div>
  </div>
  <ul id="savedMemoList"></ul>
</div>

<script>
  const CATEGORIES = [
    "LOの趣旨","レンズの長さ","アイレベル","光源","キャラクター","素材とカメラ","参考資料"
  ];
  const collator = new Intl.Collator('ja', { numeric: true, sensitivity: 'base' });

  function getSavedMemos(){ try{ return JSON.parse(localStorage.getItem("savedMemos"))||[] }catch{ return [] } }
  function setSavedMemos(m){ localStorage.setItem("savedMemos", JSON.stringify(m)); }

  function switchTab(tab){
    document.getElementById('createTabContent').classList.toggle('active', tab==='create');
    document.getElementById('listTabContent').classList.toggle('active', tab==='list');
    document.getElementById('tabCreate').classList.toggle('active', tab==='create');
    document.getElementById('tabList').classList.toggle('active', tab==='list');
    if (tab==='list') loadSavedMemos();
  }

  function fileToDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

  function createCategories(){
    const title = document.getElementById("title").value.trim();
    const cutNumber = document.getElementById("cutNumber").value.trim();
    if(!title||!cutNumber){ alert("話数 と cut を入力してください。"); return; }

    const wrap = document.getElementById("categories");
    wrap.innerHTML = `<h3>${title} - cut ${cutNumber}</h3>`;
    CATEGORIES.forEach((cat, i)=>{
      const div = document.createElement('div');
      div.className = 'category';
      div.innerHTML = `
        <label>${cat}</label>
        <textarea placeholder="メモ作成: ${cat}"></textarea>
        ${i===CATEGORIES.length-1 ? `
          <input type="file" accept="image/*" onchange="previewCreateImage(event)"/>
          <div class="image-preview"></div>
        `:``}
      `;
      wrap.appendChild(div);
    });
    const btn = document.createElement('button');
    btn.className = 'button saveButton';
    btn.textContent = '保存';
    btn.onclick = ()=>saveMemoFromCreate(title, cutNumber);
    wrap.appendChild(btn);
    wrap.style.display = 'block';
  }

  function previewCreateImage(e){
    const box = e.target.closest('.category').querySelector('.image-preview');
    box.innerHTML = '';
    const f = e.target.files?.[0];
    if(f){
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.onclick = ()=>window.open(img.src, "_blank");
      box.appendChild(img);
    }
  }

  async function saveMemoFromCreate(title, cutNumber){
    const wrap = document.getElementById("categories");
    const memoData = {};
    for(let i=0;i<CATEGORIES.length;i++){
      const cat=CATEGORIES[i];
      const ta = wrap.querySelector(`textarea[placeholder="メモ作成: ${CSS.escape(cat)}"]`);
      memoData[cat] = ta ? ta.value : "";
      if(i === CATEGORIES.length-1){
        const file = wrap.querySelector('input[type="file"]')?.files?.[0];
        if(file){ memoData[`${cat}_image`] = await fileToDataURL(file); }
      }
    }
    const arr = getSavedMemos();
    arr.push({ title, cutNumber, memoData, date: new Date().toISOString() });
    // 기본 저장 시엔 제목순으로 정렬
    arr.sort((a,b)=>{
      const t = collator.compare(a.title, b.title);
      return t!==0 ? t : collator.compare(a.cutNumber, b.cutNumber);
    });
    setSavedMemos(arr);
    alert("保存されました!");

    // 입력 UI 초기화
    document.getElementById("title").value = "";
    document.getElementById("cutNumber").value = "";
    wrap.innerHTML = "";
    wrap.style.display = "none";
  }

  function loadSavedMemos(){
    const list = document.getElementById("savedMemoList");
    list.innerHTML = "";
    const memos = getSavedMemos();

    memos.forEach((m, idx)=>{
      const li = document.createElement('li');
      li.id = `memo-${idx}`;

      const head = document.createElement('div');
      head.className = "memo-head";
      head.innerHTML = `
        <div class="memo-title">${m.title} - cut ${m.cutNumber}</div>
        <div class="memo-actions">
          <button class="button" onclick="toggleDetails(${idx})">보기</button>
          <button class="button deleteButton" onclick="deleteMemo(${idx})">削除</button>
        </div>
      `;
      li.appendChild(head);

      const details = document.createElement('div');
      details.className = "details";
      details.id = `details-${idx}`;
      li.appendChild(details);

      list.appendChild(li);
    });
  }

  function toggleDetails(index){
    const panel = document.getElementById(`details-${index}`);
    if(panel.classList.contains('visible')){ panel.classList.remove('visible'); return; }
    renderDetailsView(index);
  }

  function renderDetailsView(index){
    const memos = getSavedMemos();
    const memo = memos[index];
    const panel = document.getElementById(`details-${index}`);
    panel.innerHTML = "";

    const head = document.createElement('div');
    head.className = "row";
    head.innerHTML = `<div><strong>タイトル:</strong> ${memo.title}</div>
                      <div><strong>cut番号:</strong> ${memo.cutNumber}</div>`;
    panel.appendChild(head);

    CATEGORIES.forEach(cat=>{
      const div = document.createElement('div');
      div.className = 'category';
      const val = memo.memoData[cat] || "";
      div.innerHTML = `<label>${cat}</label><textarea readonly>${val}</textarea>`;
      const img = memo.memoData[`${cat}_image`];
      if(img){
        const wrap = document.createElement('div');
        wrap.className = 'image-preview';
        const el = document.createElement('img');
        el.src = img;
        el.onclick = ()=>window.open(el.src, "_blank");
        wrap.appendChild(el);
        div.appendChild(wrap);
      }
      panel.appendChild(div);
    });

    const btns = document.createElement('div');
    btns.className = 'row';
    btns.innerHTML = `
      <button class="button closeButton" onclick="closeDetails(${index})">閉じる</button>
      <button class="button editButton" onclick="renderDetailsEdit(${index})">編集</button>`;
    panel.appendChild(btns);

    panel.classList.add('visible');
  }

  function closeDetails(index){
    const panel = document.getElementById(`details-${index}`);
    panel.classList.remove('visible');
  }

  /* --- 편집(編集) 모드/저장 함수들은 이전과 동일 — 생략 없이 그대로 동작합니다 --- */
  function renderDetailsEdit(index){
    const memos=getSavedMemos(); const memo=memos[index];
    const panel=document.getElementById(`details-${index}`); panel.innerHTML="";
    const head=document.createElement('div'); head.className="row";
    head.innerHTML=`<div><strong>タイトル:</strong> <input id="edit-title-${index}" value="${memo.title}" class="short-input"/></div>
                    <div><strong>cut番号:</strong> <input id="edit-cut-${index}" value="${memo.cutNumber}" class="short-input"/></div>`;
    panel.appendChild(head);
    CATEGORIES.forEach((cat,i)=>{
      const div=document.createElement('div'); div.className="category";
      const val=memo.memoData[cat]||"";
      div.innerHTML=`<label>${cat}</label><textarea id="edit-text-${index}-${i}">${val}</textarea>
                     ${i===CATEGORIES.length-1?`
                       <div class="row">
                         <input type="file" id="edit-file-${index}" accept="image/*"/>
                         <button class="button closeButton" type="button" onclick="removeEditImage(${index})">이미지 삭제</button>
                       </div>
                       <div id="edit-preview-${index}" class="image-preview"></div>`:``}`;
      panel.appendChild(div);
    });
    const last=CATEGORIES[CATEGORIES.length-1];
    const cur=memo.memoData[`${last}_image`];
    const preview=panel.querySelector(`#edit-preview-${index}`);
    if(preview && cur){ const img=document.createElement('img'); img.src=cur; img.onclick=()=>window.open(img.src,"_blank"); preview.appendChild(img); }
    const file=panel.querySelector(`#edit-file-${index}`);
    if(file){ file.onchange=(e)=>{ if(!preview) return; preview.innerHTML=""; const f=e.target.files?.[0]; if(f){ const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.onclick=()=>window.open(img.src,"_blank"); preview.appendChild(img);} } }
    const btns=document.createElement('div'); btns.className="row";
    btns.innerHTML=`<button class="button saveButton" onclick="saveEdit(${index})">保存</button>
                    <button class="button closeButton" onclick="renderDetailsView(${index})">キャンセル</button>`;
    panel.appendChild(btns);
    panel.classList.add('visible'); panel.dataset.removeImage="false";
  }

  function removeEditImage(index){
    const panel=document.getElementById(`details-${index}`);
    const prev=panel.querySelector(`#edit-preview-${index}`); if(prev) prev.innerHTML="";
    const fi=panel.querySelector(`#edit-file-${index}`); if(fi) fi.value="";
    panel.dataset.removeImage="true";
  }

  async function saveEdit(index){
    const memos=getSavedMemos(); const memo=memos[index];
    const newTitle=document.getElementById(`edit-title-${index}`).value.trim();
    const newCut=document.getElementById(`edit-cut-${index}`).value.trim();
    if(!newTitle||!newCut){ alert("タイトル と cut番号 は必須です。"); return; }
    const data={};
    for(let i=0;i<CATEGORIES.length;i++){
      const cat=CATEGORIES[i]; const ta=document.getElementById(`edit-text-${index}-${i}`);
      data[cat]=ta?ta.value:"";
    }
    const last=CATEGORIES[CATEGORIES.length-1];
    const panel=document.getElementById(`details-${index}`);
    const remove=panel.dataset.removeImage==="true";
    const fi=document.getElementById(`edit-file-${index}`);
    if(remove){ delete data[`${last}_image`]; }
    else if(fi && fi.files && fi.files.length>0){ data[`${last}_image`]=await fileToDataURL(fi.files[0]); }
    else if(memo.memoData[`${last}_image`]){ data[`${last}_image`]=memo.memoData[`${last}_image`]; }

    memos[index]={ title:newTitle, cutNumber:newCut, memoData:data, date:new Date().toISOString() };
    setSavedMemos(memos);
    alert("更新しました。");
    renderDetailsView(index);
    const li=document.getElementById(`memo-${index}`); if(li){ const t=li.querySelector('.memo-title'); if(t) t.textContent=`${newTitle} - cut ${newCut}`; }
  }

  function deleteMemo(index){
    const memos=getSavedMemos(); memos.splice(index,1); setSavedMemos(memos);
    loadSavedMemos();
  }

  /* ▶ 정렬 버튼: 자연 정렬 + 날짜 정렬 고침 */
  function sortMemosByTitle(){
    const memos=getSavedMemos();
    memos.sort((a,b)=>{
      const t = collator.compare(a.title, b.title);
      if (t !== 0) return t;
      return collator.compare(a.cutNumber, b.cutNumber);
    });
    setSavedMemos(memos);
    loadSavedMemos();
  }
  function sortMemosByDate(){
    const memos=getSavedMemos();
    memos.sort((a,b)=> new Date(b.date) - new Date(a.date));
    setSavedMemos(memos);
    loadSavedMemos();
  }

  window.onload = ()=>{ loadSavedMemos(); };
</script>
</body>
</html>
